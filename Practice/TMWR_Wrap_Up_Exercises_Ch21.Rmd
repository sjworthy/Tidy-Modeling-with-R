---
title: "TMWR_Wrap_Up_Exercises_Ch21"
author: "Sam Worthy"
date: "2024-08-14"
output: html_document
---

This exercise is designed to test skills learned in Chapter 21: Inferential Analysis from Tidy Modeling in R

```{r}
library(tidymodels)
tidymodels_prefer()
library(tidyverse)
library(broom)
library(infer)
library(parsnip)
library(poissonreg)
library(multilevelmod)
```

```{r}
data = read.csv("practice.data.csv")
```

Calculate abundance of each plot

```{r}
abundance = data %>%
  group_by(Plot,Elevation,Elevation.Group) %>%
  count()
```

```{r}
traits = data %>%
  group_by(Plot,Elevation,Elevation.Group)%>%
    summarize(mean.SLA = mean(sla),
            mean.LMF = mean(lmf),
            mean.RMF = mean(rmf),
            Soil = mean(Comp.1),
            Light = mean(perc.canopy.open),
            n.Species = length(unique(sp)))
```

```{r}
final.data = merge(abundance,traits)
colnames(final.data)[4] = "Abundance"
final.data$log.SLA = scale(final.data$mean.SLA)
final.data$log.LMF = scale(final.data$mean.LMF)
final.data$log.RMF = scale(final.data$mean.RMF)
final.data$log.Soil = scale(final.data$Soil)
final.data$log.Light = scale(final.data$Light)
```

```{r}
write.csv(final.data, file = "final.data.csv")
```

```{r}
final.data = read.csv("final.data.csv")
```


This data comes from a tropical rainforest seedling community in Xishuangbanna, China. Originally, the data included trait data measured on individual seedlings and plot-level environmental data and was used to make inferences about how interactions among traits explain patterns relative growth rate of seedlings across light and soil nutrient gradients. The publication can be found [here](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1002/ecy.3007). For this exercise, I have adapted the data as well as "made-up" some new variables to better match the chapter data. All the continuous variables have been centered and scaled.

The data include

-   Plot - 1 x 1 meter plots random distributed in the forest to capture the seedling community
-   Elevation - Elevation of the plot in meters
-   Elevation.Group - Elevation classified as Low or High
-   Abundance - total number of individual seedlings in each plot
-   log.SLA - mean specific leaf area of all individuals in the plot, ratio of leaf area to leaf dry mass, high values indicate lighter leaves that photosynthesize more quickly.
-   log.LMF - mean leaf mass fraction of all individuals in the plot, total leaf dry mass divided by whole plant dry mass, represents biomass allocation to leaves
-   log.RMF - mean root mass fraction of all individuals in the plot, total root dry mass divided by whole plant dry mass, represents biomass allocation to roots
-   log.Soil - scores from the first axis of PCA, higher values mean more nutrient rich soil
-   log.Light - percent canopy openness above the plot, higher values mean more open canopy and access to light
-   n.Species - number of species in each plot

The goal of this exercise is to try to explain differences in abundance among the plots.

## Exercise 1

Visualize the distribution of seedling abundance data. What do you notice about the distribution?

```{r}
ggplot(final.data, aes(x = Abundance)) + 
  geom_histogram(binwidth = 1, color = "white") + 
  labs(x = "Number of seedlings in plots")
```

## Exercise 2

Our first hypothesis is that there is a difference in abundance between Low and High elevation groups. Show how you would summarize the data to test this hypothesis and then analyse the data to test the hypothesis. Hint: This data was collected over the same 1 year period for all of the plots across all elevations. Was the hypothesis supported?

```{r}
final.data %>% 
  group_by(Elevation.Group) %>% 
  summarize(counts = sum(Abundance), n = length(Abundance))
```

```{r}
poisson.test(c(718, 759), T = 1)
poisson.test(c(718, 759), T = c(99,101))
```

Making the results tidy

```{r}
poisson.test(c(718, 759), T = 1) %>%
  tidy()
```

## Exercise 3

Let's test the hypothesis under fewer distributional assumptions than the Poisson distribution. 

1. Use the `infer` package to perform a more powerful hypothesis test of the difference in abundance means between the elevation groups. 
2. Compute a confidence interval around the mean
3. Visualize the bootstrap data with confidence intervals
4. Calculate a p-value
5. Visualize the permuted p-values with the observed value

```{r}
observed <- 
  final.data %>%
  specify(Abundance ~ Elevation.Group) %>%
  calculate(stat = "diff in means", order = c("Low", "High"))
observed
```

```{r}
set.seed(2101)
bootstrapped <- 
  final.data %>%
  specify(Abundance ~ Elevation.Group)  %>%
  generate(reps = 2000, type = "bootstrap") %>%
  calculate(stat = "diff in means", order = c("Low", "High"))
bootstrapped
```

```{r}
percentile_ci <- get_ci(bootstrapped)
percentile_ci
```

```{r}
visualize(bootstrapped) +
    shade_confidence_interval(endpoints = percentile_ci)
```

```{r}
set.seed(2102)
permuted <- 
  final.data %>%
  specify(Abundance ~ Elevation.Group)  %>%
  hypothesize(null = "independence") %>%
  generate(reps = 2000, type = "permute") %>%
  calculate(stat = "diff in means", order = c("Low", "High"))
permuted
```

```{r}
permuted %>%
  get_p_value(obs_stat = observed, direction = "two-sided")
```


```{r}
visualize(permuted) +
    shade_p_value(obs_stat = observed, direction = "two-sided")
```

## Exercise 4

The two-sample tests performed above are suboptimal because they do not account for other factors that might explain abundance. We will now move to generalized linear models (glm). 

1. Fit a model of Abundance that includes all predictors in the data frame except Plot and n.Species. Which predictors are significant?
2. Conduct a rough test of the model assumptions
3. Determine which predictors to keep in the model. Fit the reduced model with only significant predictors found in Step 2

Should we use the full model or the reduced model?

```{r}
log_lin_spec <- poisson_reg()

log_lin_fit <- log_lin_spec %>% 
  fit(Abundance ~ Elevation + Elevation.Group + log.SLA + log.LMF + log.RMF + log.Soil + log.Light, data = final.data)
log_lin_fit
```

```{r}
tidy(log_lin_fit, conf.int = TRUE, conf.level = 0.90)
```

```{r}
set.seed(2103)
glm_boot <- 
  reg_intervals(Abundance ~ Elevation + Elevation.Group + log.SLA + log.LMF + log.RMF + log.Soil + log.Light, data = final.data, model_fn = "glm", family = poisson)
glm_boot
```

```{r}
log_lin_reduced <- 
  log_lin_spec %>% 
  fit(Abundance ~ log.RMF, data = final.data)

anova(
  extract_fit_engine(log_lin_reduced),
  extract_fit_engine(log_lin_fit),
  test = "LRT") %>%
  tidy()
```

## Exercise 5

This data set is no zero-inflated so we will deviate from the book chapter here. Our data does, however, have groupings as part of the set-up where plots were distributed across elevations. Instead of elevation being a predictor, let's make it a random-effect. You will need the package `multilevelmod` for this analysis. Hint: Review the engine types to set the correct for. These can be viewed used `?poisson_reg`.

1. Fit a generalized linear mixed-effects model with Elevation as the random effect.
2. Visualize the tidy model summary. You will need the `broom.mixed` package.
3. Use AIC to compare the full model fit above to the new model with the random effect. Create 500 model fits and extract the AIC values. Which model was better fit?


```{r}
glmer_spec <- poisson_reg() %>% set_engine("glmer")

glmer_fit <- glmer_spec %>% 
  fit(Abundance ~ Elevation.Group + log.SLA + log.LMF + log.RMF + log.Soil + log.Light + (1|Elevation), data = final.data)
glmer_fit
```

```{r}
tidy(glmer_fit, conf.int = TRUE, conf.level = 0.90)
```

```{r}
log_lin_fit %>% extract_fit_engine() %>% AIC()
glmer_fit   %>% extract_fit_engine() %>% AIC()
```

```{r}
glmer_form <- Abundance ~ Elevation.Group + log.SLA + log.LMF + log.RMF + log.Soil + log.Light + (1|Elevation)
glm_form <-  Abundance ~ Elevation + Elevation.Group + log.SLA + log.LMF + log.RMF + log.Soil + log.Light

set.seed(2104)
bootstrap_models <-
  bootstraps(final.data, times = 500, apparent = TRUE) %>%
  mutate(
    glm = map(splits, ~ fit(log_lin_spec, glm_form, data = analysis(.x))),
    glmer = map(splits, ~ fit(glmer_spec, glmer_form, data = analysis(.x)))
  )
bootstrap_models
```

```{r}
bootstrap_models <-
  bootstrap_models %>%
  mutate(
    glm_aic = map_dbl(glm, ~ extract_fit_engine(.x) %>% AIC()),
    glmer_aic = map_dbl(glmer, ~ extract_fit_engine(.x) %>% AIC())
  )
mean(bootstrap_models$glmer_aic < bootstrap_models$glm_aic)
```

## Exercise 6

From the bootstrap_models generated above, extract and plot the model coefficients.

```{r}
bootstrap_models <-
  bootstrap_models %>%
  mutate(glmer_coefs  = map(glmer, ~ tidy(.x, type = "zero")))
```

```{r}
bootstrap_models %>% 
  unnest(glmer_coefs) %>% 
  ggplot(aes(x = estimate)) +
  geom_histogram(bins = 25, color = "white") + 
  facet_wrap(~ term, scales = "free_x") + 
  geom_vline(xintercept = 0, lty = 2, color = "gray70")
```

